<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è›‹ç™½è´¨å¯è§†åŒ–å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.1.0/3Dmol-min.js"></script>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
        :root {
            --primary: #2196F3;
            --secondary: #4CAF50;
            --background: #f8f9fa;
            --error-bg: #f8d7da;
            --error-text: #721c24;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background: var(--background);
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 2.2rem;
        }

        .subtitle {
            color: gray;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        #viewer3d {
            width: 100%;
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        #model-viewer-container {
            width: 100%;
            height: 600px;
            display: none;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
            background: white;
            border: 1px solid #e0e0e0;
            position: relative;
        }

        model-viewer {
            width: 100%;
            height: 100%;
        }

        .controls {
            margin-top: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .control-group {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .control-group h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button {
            padding: 13px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            font-size: 1rem;
            width: 100%;
            text-align: left;
            box-shadow: 0 2px 5px rgba(33, 150, 243, 0.3);
        }

        button:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.4);
        }

        button.active {
            background: var(--secondary);
            box-shadow: 0 2px 8px rgba(76,175,80,0.4);
        }

        .status-bar {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid var(--primary);
        }

        .annotation-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.97);
            border-radius: 10px;
            padding: 20px;
            font-size: 14px;
            color: #333;
            max-width: 280px;
            z-index: 10;
            line-height: 1.7;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border: 1px solid #eee;
        }
        
        .annotation-panel ul {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }
        
        .annotation-panel li {
            margin-bottom: 8px;
        }
        
        .annotation-panel strong {
            font-size: 18px;
            color: #1976D2;
            display: block;
            margin-bottom: 10px;
        }

        /* æ¨¡å‹é€‰æ‹©å™¨æ ·å¼ */
        #modelSelector {
            padding: 13px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        
        #modelSelector:hover {
            border-color: #2196F3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }
        
        /* é”™è¯¯æç¤ºæ ·å¼ */
        .error-panel {
            margin-top: 25px;
            padding: 20px;
            background-color: var(--error-bg);
            color: var(--error-text);
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            display: none;
            border-left: 4px solid #d9534f;
        }
        
        .error-title {
            font-weight: bold;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .error-title::before {
            content: "âš ï¸";
            font-size: 1.5rem;
        }
        
        .error-content {
            margin-top: 15px;
        }
        
        .error-list {
            margin: 15px 0 æ 25px;
            padding: 0;
        }
        
        .error-list li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        /* åº•éƒ¨æ°´å°æ ·å¼ */
        .footer-watermark {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 20px 0;
            background: white;
            margin-top: 30px;
            border-top: 1px solid #eee;
            border-radius: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .watermark-content {
            display: flex;
            align-items: center;
            gap: 25px;
            max-width: 800px;
            width: 100%;
            justify-content: center;
        }
            
        .logo-container {
            width: 80px;
            height: 80px;
            padding: 8px;
            background: white;
            border-radius: 12px;
            /* box-shadow: 0 3px 10px rgba(0,0,0,0.1); */
        }

        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .text-container {
            text-align: center;
            font-size: 15px;
            color: #555;
            line-height: 1.6;
        }

        .text-container div:first-child {
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            color: #2196F3;
            margin-bottom: 6px;
        }
        
        .renderer-toggle {
            margin-top: 20px;
            background: #f8fafb;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .renderer-label {
            font-size: 16px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .renderer-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .renderer-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }

        .renderer-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .renderer-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        input:checked + .renderer-slider {
            background-color: #2196F3;
        }

        input:checked + .renderer-slider:before {
            transform: translateX(30px);
        }
        
        .mode-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .info-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            background: #2196F3;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* è‡ªåŠ¨æ—‹è½¬æ§åˆ¶æŒ‰é’® */
        #rotation-control {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 30px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            display: none; /* é»˜è®¤éšè— */
        }
        
        #rotation-control:hover {
            background: white;
            box-shadow: 0 3px 12px rgba(0,0,0,0.15);
        }
        
        #rotation-control.active {
            background: #e3f2fd;
            border-color: #bbdefb;
        }
        
        #rotation-control i {
            font-size: 18px;
        }
        
        #rotation-control span {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        
        /* ç§»åŠ¨ç«¯æ ·å¼é€‚é… */
        @media (max-width: 768px) {
            body {
                padding: 8px 6px;
            }
            
            header {
                margin-bottom: 10px;
            }
            
            h1 {
                font-size: 1.3rem;
                margin-bottom: 3px;
            }
            
            .subtitle {
                font-size: 0.8rem;
                margin-bottom: 8px;
            }
            
            #viewer3d,
            #model-viewer-container {
                height: 300px;
                border-radius: 8px;
            }
            
            .renderer-toggle {
                padding: 8px 6px;
                margin-top: 15px;
            }
            
            .renderer-label {
                font-size: 11px;
            }
            
            .renderer-switch {
                width: 45px;
                height: 22px;
            }
            
            .renderer-slider:before {
                height: 16px;
                width: 16px;
                bottom: 3px;
            }
            
            input:checked + .renderer-slider:before {
                transform: translateX(23px);
            }
            
            .controls {
                gap: 10px;
                margin-top: 15px;
            }
            
            .control-group {
                padding: 12px 10px;
            }
            
            /* åªåœ¨æ‰‹æœºç«¯ç§»é™¤æ ‡é¢˜æ–‡å­— */
            .control-group h3 {
                font-size: 0; /* éšè—æ–‡å­—å†…å®¹ */
                height: 0;    /* ç§»é™¤é«˜åº¦ */
                margin-bottom: 0; /* ç§»é™¤åº•éƒ¨è¾¹è· */
            }
            
            /* ç§»é™¤ä¿¡æ¯å›¾æ ‡ */
            .info-icon {
                display: none !important;
            }
            
            .mode-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            button {
                padding: 8px 6px;
                font-size: 0.8rem;
                gap: 4px;
                text-align: center;
                justify-content: center;
                box-shadow: 0 1px 2px rgba(33, 150, 243, 0.3);
            }
            
            button:hover {
                transform: translateY(-1px);
            }
            
            #rotation-control {
                position: absolute;
                top: 15px;
                right: 13px;
                z-index: 20;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 30px;
                padding: 5px 10px;
                display: flex;
                align-items: center;
                gap: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                border: 1px solid #e0e0e0;
                cursor: pointer;
                transition: all 0.3s;
                display: none; /* é»˜è®¤éšè— */
            }
            
            
            #rotation-control i {
                font-size: 13px;
            }
            
            #rotation-control span {
                font-size: 11px;
                font-weight: 500;
                color: #333;
            }

            .annotation-panel {
                top: 6px;
                right: 6px;
                max-width: 40%;
                padding: 7px 8px;   /* è°ƒæ•´å†…è¾¹è· */
                font-size: 0.65rem;   /* å­—ä½“æ›´å° */
                line-height: 1.4;
                background: rgba(255, 255, 255, 0.4);
            }
            
            .annotation-panel strong {
                font-size: 0.7rem;
                margin-bottom: 4px;
            }
            
            .status-bar {
                margin-top: 12px;
                font-size: 0.85rem;
                padding: 8px 10px;
            }
            
            /* ä¿®æ”¹æ°´å°ä¸ºæ°´å¹³æ’åˆ— */
            .watermark-content {
                flex-direction: row;
                gap: 2px;
                text-align: center;
                align-items: center;
            }
            
            .logo-container {
                width: 50px;
                height: 50px;
                margin: 0;
            }
            
            .text-container {
                text-align: center;
                font-size: 9px;
            }
            
            .text-container div:first-child {
                text-align: center;
                font-size: 13px;
                margin-bottom: 1px;   /* è®¾ç½®æ ‡é¢˜ä¸å°å­—çš„é—´è· */
            }
            
            #modelSelector {
                padding: 8px 6px;
                font-size: 0.85rem;
            }
        }
        
        /* ç”µè„‘ç«¯ä¸“ç”¨ä¿®å¤ - ç¡®ä¿å®Œå…¨æ¢å¤å›¾ä¸€æ•ˆæœ */
        @media (min-width: 769px) {
            /* ç¡®ä¿æ ‡é¢˜å’Œå›¾æ ‡å¯è§ */
            .control-group h3 {
                display: flex;
                font-size: 1.2rem;
                height: auto;
                margin-bottom: 15px;
            }
            
            /* ç¡®ä¿ä¿¡æ¯å›¾æ ‡å¯è§ */
            .info-icon {
                display: inline-block !important;
            }
            
            /* æ¢å¤æŒ‰é’®é¢œè‰² - å›¾ä¸€æ•ˆæœ */
            .control-group#displayModesPanel .mode-buttons button {
                background: #2196F3; /* é»˜è®¤è“è‰² */
            }
            
            .control-group#displayModesPanel .mode-buttons button.active {
                background: #4CAF50; /* é£˜å¸¦æ¨¡å‹ç»¿è‰² */
            }
            
            /* æ‰€æœ‰éæ´»åŠ¨æŒ‰é’®ä¸ºè“è‰² */
            .control-group#displayModesPanel .mode-buttons button:not(.active) {
                background: #2196F3;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>è›‹ç™½è´¨ä¸‰ç»´ç»“æ„å¯è§†åŒ–å¹³å°</h1>
            <div class="subtitle">äº¤äº’å¼æ¢ç´¢è›‹ç™½è´¨çš„åˆ†å­ç»“æ„ä¸åŠŸèƒ½</div>
        </header>
        
        <div class="renderer-toggle">
            <span class="renderer-label">3DMol.js æ¸²æŸ“å™¨</span>
            <label class="renderer-switch">
                <input type="checkbox" id="rendererSwitch" onchange="toggleRenderer()">
                <span class="renderer-slider"></span>
            </label>
            <span class="renderer-label">Three.js æ¸²æŸ“å™¨</span>
        </div>
        
        <div id="viewer3d">
            <div class="annotation-panel" id="annotation-panel">
                <strong>é£˜å¸¦æ¨¡å‹ (Ribbon)</strong>
                <b>å®šä¹‰ï¼š</b>ç”¨æ‰å¹³é£˜å¸¦è¡¨ç¤ºè›‹ç™½è´¨äºŒçº§ç»“æ„ï¼ˆÎ±èºæ—‹ä¸ºèºæ—‹çŠ¶ï¼ŒÎ²æŠ˜å ä¸ºç®­å¤´ï¼‰ã€‚
                <b>ç‰¹ç‚¹ï¼š</b>å¿½ç•¥åŸå­ç»†èŠ‚ï¼Œçªå‡ºè›‹ç™½è´¨éª¨æ¶çš„æŠ˜å æ¨¡å¼ï¼Œå¸¸ç”¨é¢œè‰²åŒºåˆ†ä¸åŒç»“æ„åŸŸæˆ–é“¾ã€‚
            </div>
            
            <div class="loading-indicator" id="loadingIndicator">
                <div class="spinner"></div>
                <div>æ­£åœ¨åŠ è½½æ¨¡å‹ï¼Œè¯·ç¨å€™...</div>
            </div>
        </div>
        
        <div id="model-viewer-container">
            <model-viewer 
                id="model-viewer" 
                alt="è›‹ç™½è´¨ä¸‰ç»´æ¨¡å‹"
                auto-rotate
                camera-controls
                shadow-intensity="1"
                camera-orbit="45deg 55deg 105%"
                style="background-color: #FFFFFF"
            ></model-viewer>
            
            <!-- è‡ªåŠ¨æ—‹è½¬æ§åˆ¶æŒ‰é’® -->
            <div id="rotation-control" class="active" onclick="toggleAutoRotation()">
                <i>â¹ï¸</i>
                <span>è‡ªåŠ¨æ—‹è½¬</span>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3><span class="info-icon">i</span> æ¨¡å‹é€‰æ‹©</h3>
                <select id="modelSelector" onchange="loadSelectedModel()" title="é€‰æ‹©è¦æŸ¥çœ‹çš„è›‹ç™½è´¨æ¨¡å‹">
                    <option value="1e6b">1E6B - Zeta class glutathione S-transferase</option>
                    <option value="4ins">4INS - Phosphate-free ribonuclease A</option>
                    <option value="7rsa_alpha1">7RSA Alphaèºæ—‹</option>
                    <option value="7rsa_beta146_betasheet">7RSA BetaæŠ˜å ç‰‡</option>
                    <option value="7rsa_loop2_loop">7RSA ç¯çŠ¶ç»“æ„</option>
                    <option value="7rsa_turn1_turn">7RSA è½¬è§’ç»“æ„</option>
                    <option value="my_structure">è‡ªå®šä¹‰ç»“æ„</option>
                </select>
            </div>
            
            <div class="control-group" id="displayModesPanel">
                <h3><span class="info-icon">i</span> æ˜¾ç¤ºæ¨¡å¼</h3>
                <div class="mode-buttons">
                    <button onclick="setDisplayMode('ribbon')" class="active">ğŸ—ï¸ é£˜å¸¦æ¨¡å‹</button>
                    <button onclick="setDisplayMode('wireframe')">ğŸ”² çº¿æ£’æ¨¡å‹</button>
                    <button onclick="setDisplayMode('ballstick')">âš¾ æ£’çƒæ£æ¨¡å‹</button>
                    <button onclick="setDisplayMode('spacefill')">ğŸ”µ ç©ºé—´å¡«å……æ¨¡å‹</button>
                    <button onclick="setDisplayMode('surface')">ğŸŸ¢ è¡¨é¢å¡«å……æ¨¡å‹</button>
                    <button onclick="setDisplayMode('hydrophobic')">ğŸŒŠ äº²ç–æ°´åˆ†å¸ƒ</button>
                </div>
            </div>
        </div>

        <div class="status-bar" id="status">
            <span>ğŸ”µ</span> æ­£åœ¨åŠ è½½æ¨¡å‹...
        </div>
        
        <!-- é”™è¯¯æ¶ˆæ¯å®¹å™¨ -->
        <div class="error-panel" id="error-message">
            <div class="error-title">æ¨¡å‹åŠ è½½å¤±è´¥ï¼šHTTPé”™è¯¯ 404</div>
            <div class="error-content">
                <p>è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½åŸå› ï¼š</p>
                <ul class="error-list">
                    <li>æ¨¡å‹æ–‡ä»¶æœªä¸Šä¼ åˆ°æœåŠ¡å™¨</li>
                    <li>æ–‡ä»¶è·¯å¾„æˆ–åç§°ä¸æ­£ç¡®</li>
                    <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
                    <li>æœåŠ¡å™¨é™åˆ¶</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // æ¸²æŸ“å™¨çŠ¶æ€
        let useModelViewer = false;
        let currentModel = '1e6b';
        let modelViewer;
        let autoRotationEnabled = false; // è‡ªåŠ¨æ—‹è½¬é»˜è®¤å…³é—­
        
        // é¡µé¢åˆå§‹åŒ–
        window.onload = function() {
            // åˆå§‹åŒ–Model Viewer
            modelViewer = document.getElementById('model-viewer');
            
            // åˆå§‹åŒ–3DmolæŸ¥çœ‹å™¨
            window.viewer = $3Dmol.createViewer("viewer3d", {
                background: "#ffffff",
                defaultcolors: $3Dmol.elementColors.JMol
            });
            
            // åŠ è½½æ¨¡å‹
            loadModel();
            viewer.enableZoom(true);
            viewer.enablePan(true);
        };
        
        // åˆ‡æ¢æ¸²æŸ“å™¨
        function toggleRenderer() {
            useModelViewer = !useModelViewer;
            
            // é‡æ–°åŠ è½½å½“å‰æ¨¡å‹
            loadModel(currentModel);
        }
        
        // åˆ‡æ¢è‡ªåŠ¨æ—‹è½¬
        function toggleAutoRotation() {
            autoRotationEnabled = !autoRotationEnabled;
            const rotationControl = document.getElementById('rotation-control');
            
            if (autoRotationEnabled) {
                modelViewer.setAttribute('auto-rotate', '');
                rotationControl.classList.add('active');
                rotationControl.innerHTML = '<i>ğŸ”„</i><span>è‡ªåŠ¨æ—‹è½¬</span>';
            } else {
                modelViewer.removeAttribute('auto-rotate');
                rotationControl.classList.remove('active');
                rotationControl.innerHTML = '<i>â¹ï¸</i><span>æ—‹è½¬å·²åœ</span>';
            }
        }

        // æ˜¾ç¤ºæ¨¡å¼é…ç½®
        const displayModes = {
            ribbon: {
                style: { 
                    cartoon: { 
                        colorfunc: function(atom) {
                            // é¦–å…ˆæŒ‰äºŒçº§ç»“æ„ä¿¡æ¯ä¸Šè‰²
                            if (atom.ss === 'h') { // Î±èºæ—‹-çº¢è‰²
                                return '#ff8b8d';
                            } else if (atom.ss === 'c') { // loop-é»„è‰²
                                return '#ffee6c';
                            } else { // Î²æŠ˜å å’Œå…¶ä»–-è“è‰²
                                return '#55aaff';
                            }
                        },  
                        thickness: 0.6,
                        arrows: true
                    }
                },
                label: "é£˜å¸¦æ¨¡å‹"
            },
            wireframe: {
                style: { 
                    stick: { radius: 0.12 },
                    sphere: { radius: 0, opacity: 0 }
                },
                label: "çº¿æ£’æ¨¡å‹"
            },
            ballstick: {
                style: { 
                    stick: { radius: 0.12 },
                    sphere: { radius: 0.32, opacity: 0.9 }
                },
                label: "æ£’çƒæ£æ¨¡å‹"
            },
            spacefill: {
                style: { sphere: { scale: 0.6 } },
                surface: { type: $3Dmol.SurfaceType.VDW, opts: { opacity: 0.85 } },
                label: "ç©ºé—´å¡«å……æ¨¡å‹"
            },
            surface: {
                style: {},
                surface: null,
                label: "è¡¨é¢å¡«å……æ¨¡å‹"
            },
            hydrophobic: {
                style: (hydrophobic) => ({
                    [hydrophobic]: { sphere: { color: "#FFD700", scale: 0.6 } },
                    default: { sphere: { color: "#4169E1", scale: 0.6 } }
                }),
                surface: {
                    type: $3Dmol.SurfaceType.VDW,
                    opts: { 
                        opacity: 0.7,
                        colorfunc: (atom) => hydrophobicResidues.includes(atom.resn) ? "#FFD700" : "#4169E1"
                    }
                },
                label: "äº²ç–æ°´åˆ†å¸ƒ"
            }
        };

        // å¸¸é‡å®šä¹‰
        const hydrophobicResidues = ["ALA","VAL","LEU","ILE","MET","PHE","TRP","PRO"];

        // æ³¨é‡Šä¿¡æ¯å­—å…¸
        const annotationDict = {
            ribbon: `<strong>é£˜å¸¦æ¨¡å‹ (Ribbon)</strong>
            <b>å®šä¹‰ï¼š</b>ç”¨æ‰å¹³é£˜å¸¦è¡¨ç¤ºäºŒçº§ç»“æ„ï¼ˆÎ±èºæ—‹ä¸ºèºæ—‹çŠ¶ï¼ŒÎ²æŠ˜å ä¸ºç®­å¤´ï¼‰ã€‚
            <b>ç‰¹ç‚¹ï¼š</b>å¿½ç•¥åŸå­ç»†èŠ‚ï¼Œçªå‡ºè›‹ç™½è´¨éª¨æ¶çš„æŠ˜å æ¨¡å¼ã€‚`,
            wireframe: `<strong>çº¿æ£’æ¨¡å‹ (Wireframe)</strong>
            <b>å®šä¹‰ï¼š</b>çº¿æ¡è¡¨ç¤ºåŒ–å­¦é”®ï¼ŒèŠ‚ç‚¹è¡¨ç¤ºåŸå­ã€‚
            <b>ç‰¹ç‚¹ï¼š</b>ç»“æ„ç®€æ´ï¼Œçªå‡ºåˆ†å­éª¨æ¶å’Œé”®çš„èµ°å‘ã€‚`,
            ballstick: `<strong>æ£’çƒæ£æ¨¡å‹ (Ball-and-stick)</strong>
            <b>å®šä¹‰ï¼š</b>åŸå­ç”¨å½©è‰²çƒä½“è¡¨ç¤ºï¼ŒåŒ–å­¦é”®ç”¨æ£çŠ¶è¿æ¥ã€‚
            <b>ç‰¹ç‚¹ï¼š</b>ç›´è§‚æ˜¾ç¤ºåŸå­ç±»å‹ã€é”®é•¿å’Œé”®è§’ã€‚`,
            spacefill: `<strong>ç©ºé—´å¡«å……æ¨¡å‹ (Space-filling)</strong>
            <b>å®šä¹‰ï¼š</b>åŸå­æŒ‰èŒƒå¾·ååŠå¾„æ¯”ä¾‹æ˜¾ç¤ºä¸ºçƒä½“ã€‚
            <b>ç‰¹ç‚¹ï¼š</b>æœ€æ¥è¿‘åˆ†å­å®é™…ç©ºé—´å ä½çš„è¡¨ç°æ–¹å¼ã€‚`,
            surface: `<strong>è¡¨é¢å¡«å……æ¨¡å‹ (Surface)</strong>
            <b>æå®šä¹‰ï¼š</b>é€šè¿‡ç”µå­å¯†åº¦ç­‰å€¼é¢æˆ–æº¶å‰‚å¯åŠè¡¨é¢æ„å»ºåˆ†å­è¡¨é¢ã€‚
            <b>ç‰¹ç‚¹ï¼š</b>æ˜¾ç¤ºåˆ†å­è½®å»“å’Œè¡¨é¢ç‰¹å¾ã€‚`,
            hydrophobic: `<strong>äº²ç–æ°´åˆ†å¸ƒ (Hydrophobic)</strong>
            <b>å®šä¹‰ï¼š</b>é€šè¿‡é¢œè‰²æ ‡è®°åˆ†å­çš„äº²æ°´ï¼ˆææ€§ï¼‰å’Œç–æ°´ï¼ˆéææ€§ï¼‰åŒºåŸŸã€‚
            <b>ç‰¹ç‚¹ï¼š</b>ææ€§åŒºåŸŸå¸¸ç”¨è“è‰²è¡¨ç¤ºï¼Œç–æ°´åŒºåŸŸå¸¸ç”¨é»„è‰²è¡¨ç¤ºã€‚`
        };

        // æ ¸å¿ƒæ˜¾ç¤ºå‡½æ•°
        async function setDisplayMode(mode) {
            // å¦‚æœä½¿ç”¨Model Vieweråˆ™è¿”å›
            if (useModelViewer) return;
            
            viewer.removeAllSurfaces();
            viewer.setStyle({}, {});
            const config = displayModes[mode];
            if (!config) return;

            viewer.setStyle({}, config.style);
            if (mode === 'hydrophobic') {
                viewer.setStyle({ resn: hydrophobicResidues }, config.style(hydrophobicResidues)[hydrophobicResidues]);
                viewer.setStyle({ resn: { $not: hydrophobicResidues } }, config.style().default);
                viewer.addSurface(config.surface.type, config.surface.opts);
            } else if (mode === 'surface') {
                viewer.addSurface($3Dmol.SurfaceType.VDW, {
                    opacity: 0.92,
                    color: 'spectrum',
                    smooth: 16,
                    probeRadius: 2.2
                });
            } else {
                if (config.surface) {
                    viewer.addSurface(config.surface.type, config.surface.opts);
                }
            }

            document.getElementById('status').textContent = `å½“å‰æ¨¡å¼ï¼š${config.label}`;
            document.querySelectorAll('.mode-buttons button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(config.label));
            });
            
            document.getElementById('annotation-panel').innerHTML = annotationDict[mode] || '';
            viewer.render();
        }

        // æ§åˆ¶æŒ‰é’®å¯è§æ€§
        function updateButtonVisibility() {
            const displayModesPanel = document.getElementById('displayModesPanel');
            const annotationPanel = document.getElementById('annotation-panel');
            const rotationControl = document.getElementById('rotation-control');
            
            // åœ¨Model Viewerä¸‹éšè—æŒ‰é’®å’Œæ³¨é‡Šï¼Œæ˜¾ç¤ºæ—‹è½¬æ§åˆ¶
            if (useModelViewer) {
                displayModesPanel.style.display = 'none';
                annotationPanel.style.display = 'none';
                rotationControl.style.display = 'flex';
            } else {
                displayModesPanel.style.display = 'block';
                // å¯¹äºé1e6bæ¨¡å‹ä¹Ÿéšè—æ³¨é‡Š
                annotationPanel.style.display = currentModel === '1e6b' ? 'block' : 'none';
                rotationControl.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoadingIndicator() {
            document.getElementById('loadingIndicator').style.display = 'block';
        }
        
        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoadingIndicator() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        // åŠ è½½æ¨¡å‹
        async function loadModel(modelName = '1e6b') {
            try {
                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                showLoadingIndicator();
                
                // éšè—é”™è¯¯æ¶ˆæ¯
                document.getElementById('error-message').style.display = 'none';
                document.getElementById('status').innerHTML = `<span>ğŸ”„</span> æ­£åœ¨åŠ è½½æ¨¡å‹ï¼š${modelName}...`;
                
                currentModel = modelName;
                updateButtonVisibility();
                
                // ç¡®å®šæ¸²æŸ“å™¨
                const viewerContainer = document.getElementById('viewer3d');
                const modelViewerContainer = document.getElementById('model-viewer-container');
                
                // æ ¹æ®æ¸²æŸ“å™¨é€‰æ‹©æ–‡ä»¶æ ¼å¼
                const fileExtension = useModelViewer ? 'glb' : 'pdb';
                const modelPath = `https://suyecuni.github.io/BioStruct/models/${modelName}.${fileExtension}`;
                
                if (useModelViewer) {
                    // æ˜¾ç¤ºModel Viewerï¼Œéšè—3Dmol
                    viewerContainer.style.display = 'none';
                    modelViewerContainer.style.display = 'block';
                    
                    document.getElementById('status').innerHTML = `<span>ğŸ”</span> ä½¿ç”¨Three.jsåŠ è½½æ¨¡å‹...`;
                    modelViewer.src = modelPath;
                    
                    // ç¡®ä¿è‡ªåŠ¨æ—‹è½¬çŠ¶æ€æ­£ç¡®
                    if (autoRotationEnabled) {
                        modelViewer.setAttribute('auto-rotate', '');
                    } else {
                        modelViewer.removeAttribute('auto-rotate');
                    }
                    
                    // ç­‰å¾…æ¨¡å‹åŠ è½½
                    await new Promise((resolve, reject) => {
                        modelViewer.addEventListener('load', () => {
                            resolve();
                            hideLoadingIndicator();
                        });
                        modelViewer.addEventListener('error', (err) => {
                            reject(err);
                            hideLoadingIndicator();
                        });
                    });
                    
                    document.getElementById('status').innerHTML = `<span>âœ…</span> æ¨¡å‹åŠ è½½å®Œæˆ (Three.js)`;
                } else {
                    // æ˜¾ç¤º3Dmolï¼Œéšè—Model Viewer
                    modelViewerContainer.style.display = 'none';
                    viewerContainer.style.display = 'flex';
                    
                    viewer.removeAllModels();
                    
                    document.getElementById('status').innerHTML = `<span>ğŸ”</span> ä½¿ç”¨3DMol.jsåŠ è½½æ¨¡å‹...`;
                    
                    const response = await fetch(modelPath);
                    
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯ ${response.status}`);
                    }
                    
                    const data = await response.text();
                    viewer.addModel(data, "pdb");
                    
                    // è®¾ç½®é»˜è®¤æ˜¾ç¤ºæ¨¡å¼
                    setDisplayMode('ribbon');
                    
                    viewer.zoomTo();
                    viewer.render();
                    document.getElementById('status').innerHTML = `<span>âœ…</span> æ¨¡å‹åŠ è½½å®Œæˆ (3DMol.js)`;
                    hideLoadingIndicator();
                }
                
                return true;
            } catch (error) {
                hideLoadingIndicator();
                const errorMsg = `æ¨¡å‹åŠ è½½å¤±è´¥ï¼š${error.message}`;
                document.getElementById('status').innerHTML = `<span>âŒ</span> ${errorMsg}`;
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                const errorElement = document.getElementById('error-message');
                const errorTitle = errorElement.querySelector('.error-title');
                errorTitle.textContent = errorMsg;
                errorElement.style.display = 'block';
                
                console.error(error);
                return false;
            }
        }

        // æ–°å¢é€‰æ‹©å™¨å¤„ç†å‡½æ•°
        function loadSelectedModel() {
            const selector = document.getElementById('modelSelector');
            const modelName = selector.value;
            loadModel(modelName);
        }
    </script>

    <!-- åº•éƒ¨æ°´å°åŒºåŸŸ -->
    <div class="footer-watermark">
        <div class="watermark-content">
            <div class="logo-container">
                <div class="logo">
                    <!-- ä½¿ç”¨ç»å¯¹è·¯å¾„ç¡®ä¿logoæ­£ç¡®åŠ è½½ -->
                    <img src="https://suyecuni.github.io/BioStruct/images/logo.png" alt="BioStruct Logo">
                </div>
            </div>
            <div class="text-container">
                <div>BioStructå±•ç¤ºå¹³å°</div>
                <div>è¥¿å—å¤§å­¦ç”Ÿå‘½ç§‘å­¦å­¦é™¢ | åˆ¶ä½œï¼šå…°å©·ã€è°¢ä½³å®ã€éƒ­å°çº¬</div>
                <div>Â© Southwest University | Ting Lan, Jiahong Xie, Xiaowei Guo</div>
            </div>
        </div> 
    </div>
</body>
</html>
